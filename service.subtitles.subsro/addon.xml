<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<addon id="service.subtitles.subsro"
       name="Subs.ro"
       version="1.0.8"
       provider-name="subs.ro">
	<requires>
		<import addon="xbmc.python" version="3.0.0"/>
		<import addon="script.module.requests" version="2.25.1+matrix.1"/>
	</requires>
	<extension point="xbmc.subtitle.module"
             library="service.py" />
	<extension point="xbmc.addon.metadata">
		<summary lang="en_GB">Subs.ro</summary>
		<summary lang="ro_RO">Subs.ro</summary>
		<description lang="en_GB">Search and download subtitles from Subs.ro - the largest Romanian subtitle database. Supports Romanian, English, Italian, French, German, Hungarian, Greek, Portuguese and Spanish. Register your account on subs.ro to get an API key before use.</description>
		<description lang="ro_RO">Cauta si descarca subtitrari de pe Subs.ro - cea mai mare baza de date de subtitrari romanesti. Suporta romana, engleza, italiana, franceza, germana, maghiara, greaca, portugheza si spaniola. Inregistreaza-te pe subs.ro pentru a obtine o cheie API.</description>
		<disclaimer lang="en_GB">Users need to provide a subs.ro API key in add-on configuration. You can generate an API key from your subs.ro user profile.</disclaimer>
		<news>
v1.0.8 (2026-02-24)
- CRITICAL FIX: Download "Attempt failed" error resolved
  Root cause: download_subtitle() sent Accept: application/json and
  Content-Type: application/json headers to the download endpoint.
  The API returned JSON error instead of binary ZIP/RAR archive data.
  Fix: download requests now send Accept: */* with only the API key header,
  matching the Stremio addon behavior (proxy.js only sends X-Subs-Api-Key).
- CRITICAL FIX: download() no longer calls addDirectoryItem with non-existent
  file path when extraction fails. Previously, any download/extraction error
  still passed a phantom path to Kodi, causing "Attempt failed" dialog.
  Now: errors return early, letting endOfDirectory signal no subtitle.
- Fix: archive_content variable initialized before try/except block to prevent
  UnboundLocalError when AuthenticationError or DownloadLimitExceeded is raised
- Fix: Directory cleanup uses os.path.isdir() instead of xbmcvfs.exists()
  which requires trailing path separator for directories (returned False always)
- Fix: Empty subtitle_id caught early with descriptive log message
- Fix: Download response Content-Type validated -- JSON responses from download
  endpoint are now detected and reported as errors instead of silently failing
- Fix: Raw content fallback when archive extraction returns None
- Enhanced: download() logs subtitle_id, language, season, episode at entry
- Enhanced: list_subtitles() logs subtitle_id for each result for debugging
- Keep: All v1.0.3 through v1.0.7 features preserved (multi-strategy search,
  Stremio-aligned behavior, web scraping fallback, episode-aware extraction)

v1.0.7 (2026-02-24)
- CRITICAL FIX: Aligned API calls with official subs.ro Stremio addon behavior
  Deep analysis of github.com/allecsc/stremio-subs-ro source code revealed:
  * Stremio searches WITHOUT language filter, then filters results locally
  * Our v1.0.6 was sending ?language=ro which returns FEWER results
  * Now: search without language parameter, filter locally (like Stremio)
- CRITICAL FIX: TV show filtering now returns ALL results when no S01E05 match
  Stremio returns all subtitles and lets archive extraction pick the right SRT.
  Previous versions filtered out valid full-season packs.
- New: Strategy 11 - Web scraping fallback (like POV player)
  When API returns no results, scrapes subs.ro website directly
  Finds subtitles not yet indexed in the API
- New: Video hash module for future OpenSubtitles integration
- Fix: Language-specific API search is now fallback, not primary strategy
- Fix: Removed _fetch_with_languages() per-language API calls (unnecessary overhead)
- Keep: All v1.0.3 through v1.0.6 fixes preserved

v1.0.6 (2026-02-24)
- New: Multi-strategy cascading search engine (up to 10 strategies per search)
  Research-based improvements inspired by VLC, BSPlayer, and a4kSubtitles search methods
- New: Search by episode title/name (e.g., "Ozymandias" for Breaking Bad S05E14)
  Extracts VideoPlayer.EpisodeName from Kodi InfoLabels for title-based search
- New: Original title search (searches by original title when different from display title)
- New: Release/filename search as additional fallback strategy
- New: No-language fallback repeats ALL strategies without language filter
- New: Episode title matching in _filter_tv_results() for shows without S01E05 numbering
- New: Result ranking by language priority (Romanian first) and download count
- New: Result deduplication by subtitle ID across strategies
- New: 404 responses handled gracefully (no error, just empty results)
- Fix: All IDs now preserved for multi-strategy search (no longer cleared in data_collector)
- Fix: data_collector now collects episode_title from VideoPlayer.EpisodeName
- Keep: All v1.0.5 fixes (tt prefix, items field, archive extraction, etc.)

v1.0.5 (2026-02-24)
- Fix: TV show/series subtitle search completely rewritten
- Fix: Search by show IMDB ID (parent) with episode IMDB ID as fallback
- Fix: Filter results using title/description fields (API has no season/episode fields)
- Fix: Smart cascading filter: exact episode > season-only > untagged packs > all results
- Fix: Episode-aware archive extraction picks correct S01E05 file from multi-episode ZIPs
- Fix: Season/episode passed through download URL to archive extractor
- Fix: Preserve episode_imdb_id alongside parent_imdb_id for fallback search
- Add: Title+S01E05 fallback search when IMDB ID returns no results
- Add: Description field used in subtitle display (API returns description, not release)
- Add: Romanian season patterns (Sezonul/Episodul) recognized in filtering

v1.0.4 (2026-02-23)
- Fix: IMDB IDs now sent with required 'tt' prefix (e.g. tt14142060 instead of 14142060)
- Fix: API response parsing now reads 'items' field (was incorrectly reading 'results')
- Add: Fallback search without language filter when language-specific search returns nothing
- Add: Title-based fallback search when IMDB ID search returns no results

v1.0.3 (2026-02-23)
- Fix: unsupported language codes (e.g. Russian) no longer cause HTTP 400 / Unknown error
- Unsupported languages are silently skipped; search continues for supported ones

v1.0.0 (2026-02-23)
- Initial release
- Search subtitles by IMDB ID, TMDB ID, title, release name
- Support: Romanian, English, Italian, French, German, Hungarian, Greek, Portuguese, Spanish
- ZIP and RAR archive extraction with encoding detection (UTF-8, CP1250, ISO-8859-2)
- TV show season/episode smart filtering
- Preferred language setting in addon preferences
- Debug logging toggle
		</news>
		<platform>all</platform>
		<license>GPL-3.0-only</license>
		<website>https://subs.ro</website>
		<assets>
			<icon>resources/media/subsro_logo_512x512.png</icon>
			<fanart>resources/media/subsro_fanart.jpg</fanart>
		</assets>
		<source>https://github.com/triffalin/repository.subsro</source>
	</extension>
</addon>
